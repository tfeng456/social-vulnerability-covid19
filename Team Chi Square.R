# TEAM CHI SQUARE
## Eustina Kim (kimjee8955@gmail.com)
## Tiffany Feng (tiffanyfeng456@gmail.com)
## Diana Pham (dianapham005@gmail.com)
## Kienna Qin (kqin@g.ucla.edu)

#################################################################################
# Functions

ca_counties <- read.csv("California_Counties.csv") # dataset contains all CA counties
ca_counties <- ca_counties$Name

# missingCounties is a function that will return the names of the counties that are
# missing in the input dataset
missingCounties <- function(dataset_counties){
  missing_indices <- integer(0)
  for(i in 1:length(ca_counties)){
    if(any(dataset_counties == levels(ca_counties)[i])){
      next;
    }
    else{
      missing_indices <- c(missing_indices, i)
    }
  }
  levels(ca_counties)[missing_indices]
}

# removeCounty is a function that will remove the word "County" if
# the dataset lists counties in CA including "County"
removeCounty <- function(dataset_counties){
  pattern <- "\\w+\\s+(\\w+\\s+)?(\\w+\\s+)?(?=County)"
  str_trim(str_extract(dataset_counties, pattern))
}

# removeCounty is a function that will remove the phrase "County, CA" if
# the dataset lists counties in CA including this phrase
removeCountyState <- function(dataset_counties_state){
  pattern <- "\\w+\\s+(\\w+\\s+)?(\\w+\\s+)?(?=County, CA)"
  str_trim(str_extract(dataset_counties_state, pattern))
}

# standardize is a function that will standardize the input variable
standardize <- function(variable){
  (variable - mean(variable)) / sd(variable)
}

#################################################################################

# Hospital capacity data
hospital_capacity <- read.csv("Definitive_Healthcare__USA_Hospital_Beds.csv")

## filter to CA and only choose relevant variables
hospital_capacity <- hospital_capacity %>% 
  filter(STATE_NAME == "California") %>%
  mutate(COUNTY_NAME = droplevels(COUNTY_NAME), 
         NUM_STAFFED_BEDS = as.integer(NUM_STAFFED_BEDS),
         NUM_LICENSED_BEDS = as.integer(NUM_LICENSED_BEDS),
         NUM_ICU_BEDS = as.integer(NUM_ICU_BEDS),
         ADULT_ICU_BEDS = as.integer(ADULT_ICU_BEDS),
         PEDI_ICU_BEDS = as.integer(PEDI_ICU_BEDS)) %>%
  select(HOSPITAL_NAME, HOSPITAL_TYPE, COUNTY_NAME, NUM_LICENSED_BEDS, 
         NUM_STAFFED_BEDS, NUM_ICU_BEDS, ADULT_ICU_BEDS, PEDI_ICU_BEDS,
         BED_UTILIZATION, Potential_Increase_In_Bed_Capac, AVG_VENTILATOR_USAGE)

## check for missing counties
missingCounties(levels(hospital_capacity$COUNTY_NAME))
## Alpine, Colusa, and Sierra Counties are missing

## Averages of hospital_capacity by county
hospital_capacity_summary <- hospital_capacity %>% 
  group_by(COUNTY_NAME) %>% 
  summarize(AVG_LICENSED_BEDS = mean(NUM_LICENSED_BEDS, na.rm=TRUE),
            AVG_STAFFED_BEDS = mean(NUM_STAFFED_BEDS, na.rm=TRUE),
            AVG_ICU_BEDS = mean(NUM_ICU_BEDS, na.rm=TRUE),
            AVG_ADULT_ICU_BEDS = mean(ADULT_ICU_BEDS, na.rm=TRUE),
            AVG_PEDI_ICU_BEDS = mean(PEDI_ICU_BEDS, na.rm=TRUE),
            AVG_BED_UTILIZATION = mean(BED_UTILIZATION, na.rm=TRUE),
            AVG_INC_BED_CAPAC = mean(Potential_Increase_In_Bed_Capac, na.rm=TRUE),
            AVG_VENTILATOR_USAGE = mean(AVG_VENTILATOR_USAGE, na.rm=TRUE))

#################################################################################

# Social vulnerability data
social_vulnerability <- read.csv("SVI2018.csv")

## only choose relevant variables
social_vulnerability <- social_vulnerability %>%
  mutate(TOT_POP = E_TOTPOP, HOUSING_UNITS = E_HU, POV = EP_POV,
         PC_INCOME = E_PCI, NOHSDP = EP_NOHSDP, 
         AGE65 = EP_AGE65, AGE17 = EP_AGE17, DISABLED = EP_DISABL, 
         SNG_PRNT = EP_SNGPNT, MINORITY = EP_MINRTY, ENG_LTW = EP_LIMENG, 
         CROWD = EP_CROWD, UNINSURED = EP_UNINSUR) %>%
  select(COUNTY, AREA_SQMI, TOT_POP, HOUSING_UNITS, POV, PC_INCOME,
         NOHSDP, AGE65, AGE17, DISABLED, SNG_PRNT, MINORITY, ENG_LTW,
         CROWD, UNINSURED) %>% 
  arrange(COUNTY)

## check for missing counties
missingCounties(levels(social_vulnerability$COUNTY)) 
## none missing

#################################################################################

# County health rankings data
county_health_rankings <- read.csv("us-county-health-rankings-2020.csv")

## filter to CA and only choose relevant variables
county_health_rankings <- county_health_rankings %>%
  filter(state == "California", county != "") %>% 
  mutate(FP_health = percent_fair_or_poor_health, PCP = primary_care_physicians_rate, 
         severe_housing = percent_severe_housing_problems,
         percent_aian = percent_american_indian_alaska_native, 
         percent_nhwhite = percent_non_hispanic_white) %>% 
  select(county, num_deaths, FP_health, PCP, income_ratio,
         severe_housing, percent_black, percent_asian, percent_aian, 
         percent_hispanic, percent_nhwhite)

## check for missing counties
missingCounties(levels(county_health_rankings$county))
## none missing

#################################################################################

# Combine all county data

## hospital_capacity doesn't have data on Alpine, Colusa, or Sierra counties, 
## so we will remove them from all datasets:
which(levels(ca_counties) == "Alpine" | levels(ca_counties) == "Colusa" | levels(ca_counties) == "Sierra")
## They will be rows 2, 6, and 46, respectively:
county_summary <- cbind(social_vulnerability[-c(2,6,46),], 
                           county_health_rankings[-c(2,6,46),-1], 
                           hospital_capacity_summary[,-1])

#################################################################################

# Unemployment data
library(readxl)
unemployment_data <-  read_excel("unemployment_data.xlsx")
unemployment_data <- unemployment_data %>%
  filter(FIPS == "06") %>%
  mutate(COUNTY = removeCountyState(COUNTY_STATE)) %>% 
  select(COUNTY, MONTH, LABOR_FORCE, EMPLOYED, UNEMP, UNEMP_RATE)

#################################################################################

# data cleaning

## unemployment_data
### replace NA with "San Francisco"
unemployment_data$COUNTY[is.na(unemployment_data$COUNTY)] <- "San Francisco"

### get rid of the "p" after "March-20"
unemployment_data$MONTH[755:812] <- "March-20"

### make county and month columns into factors
unemployment_data$MONTH <- factor(unemployment_data$MONTH)
unemployment_data$COUNTY <- factor(unemployment_data$COUNTY)

### delete data on counties Alpine, Colusa, and Sierra
unemployment_data <- unemployment_data %>% 
  filter(!COUNTY %in% c("Alpine","Colusa","Sierra"))

#################################################################################

# Create unemployment difference variable

## This variable will measure the change in unemployment rate due to COVID-19.
## We will the average of unemployment rates from FEB19 - FEB20
## and calculate the difference in the unemployment rate in MAR20 to this average.

### average of unemployment rates per county from FEB19 - FEB20
unemp_avg <- unemployment_data %>% 
  filter(MONTH != "March-20") %>% 
  group_by(COUNTY) %>% 
  summarize(AVG_UNEMP_RATE = mean(UNEMP_RATE))

### unemployment rates per county for MAR20
unemp_mar20 <- unemployment_data %>% 
  filter(MONTH == "March-20") %>% 
  group_by(COUNTY) %>% 
  summarize(UNEMP_RATE = mean(UNEMP_RATE))

### calculate difference in unemployment rates per county
unemp_diff <- unemp_mar20$UNEMP_RATE - unemp_avg$AVG_UNEMP_RATE

### change unemployment_data to dataset with the county name and unemployment difference
unemployment_data <- data.frame("COUNTY" = levels(droplevels(unemployment_data$COUNTY)),
                                "UNEMP_DIFF" = unemp_diff)

#################################################################################

# Create regression model for social vulnerability relationship

library(car)
require(leaps)

## Run best subsets regression to determine which predictor variables are best

bestss <- regsubsets(AVG_BED_UTILIZATION ~ HOUSING_UNITS + POV + PC_INCOME
                     + NOHSDP + AGE65 + AGE17 + DISABLED + SNG_PRNT + MINORITY
                     + ENG_LTW + CROWD + UNINSURED + num_deaths + FP_health
                     + PCP + income_ratio + severe_housing + percent_black
                     + percent_asian + percent_aian + percent_hispanic
                     + percent_nhwhite, data = county_summary, nvmax=30)
summary(bestss)

### BIC
bic <- summary(bestss)$bic
p <- length(bic)
plot(1:p, bic)
lines(1:p, bic)

### 5 vars is best: AGE17, SNG_PRNT, CROWD, severe_housing, percent_black
social_vulnerability_model <- lm(AVG_BED_UTILIZATION ~ AGE17 + SNG_PRNT + 
                                   CROWD + severe_housing + percent_black, 
                                 data = county_summary)

summary(social_vulnerability_model)
#### r2 = .37, all vars significant

par(mfrow=c(2,2))
plot(social_vulnerability_model)
#### all plots look good but possible high influence point 11

#################################################################################

# Make social vulnerability index
## Method: standardize all variables included in regression model
## and sum together to get a rank-order index

svi <- county_summary %>%
  select(COUNTY, AVG_BED_UTILIZATION, AGE17, SNG_PRNT, CROWD, severe_housing, percent_black) %>% 
  mutate(AVG_BED_UTILIZATION = standardize(AVG_BED_UTILIZATION),
         AGE17 = standardize(AGE17),
         SNG_PRNT = standardize(SNG_PRNT),
         CROWD = standardize(CROWD),
         severe_housing = standardize(severe_housing),
         percent_black = standardize(percent_black))

svi <- svi %>%
  mutate(SVI = rowSums(svi[,-1])) %>%
  select(COUNTY, SVI)

#################################################################################

# save the updated data frames to csv files
write.csv(county_summary,"~/Desktop/Datafest_2020/county_summary.csv", row.names = FALSE)
write.csv(unemployment_data,"~/Desktop/Datafest_2020/unemployment_data.csv", row.names = FALSE)
write.csv(svi, "~/Desktop/Datafest_2020/social_vulnerability_index.csv", row.names = FALSE)
